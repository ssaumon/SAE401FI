from flask import Flask, jsonify, request
import json
app = Flask(__name__)

def lire():
     with open("app/Vulnerability.json", 'r', encoding="utf-8") as f:
        contenu=json.load(f)
        return contenu

def write_json(new_data):
    with open("app/Vulnerability.json",'r+') as file:
        file_data = json.load(file)
        file_data.append(new_data)
        file.seek(0)
        json.dump(file_data, file, indent = 4)

def ajouter():
    json=request.get_json()
    required_keys = ['id', 'VulnerabilityID', 'PkgName', 'InstalledVersion', 'FixedVersion', 'Severity', 'Title', 'Description', 'References']
    missing_keys = [key for key in required_keys if key not in json]
    if missing_keys:
        return f"Missing keys: {', '.join(missing_keys)}", 400
    else:
            id=json['id']
            contenu=lire()
            for element in contenu:
                if element.get('id') == json['id']:
                    return "id already existed", 422
           
            write_json(json)
            return "Success",200

@app.route("/")
def hello_world():
    return "<p>MicroService Vulnerability</p>"

@app.route("/Vulnerability", methods=["GET","POST"])
def ListerAjouter():
    if request.method=="GET":
        contenu = lire()
        return jsonify(contenu)
    if request.method=="POST":
        return(ajouter())
    else:
        return("Bad request")

        

if __name__ == '__main__':
    app.run(host="0.0.0.0",port=5007)